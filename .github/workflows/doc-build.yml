name: sphinx-doctest

on:
  push: 
    branches:
      - main
  pull_request:


jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: false
    - name: Update submodules
      run: |
        git submodule update --init --recursive
        git submodule update --remote --merge --recursive
    - name: Set up Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: 3.8
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install --upgrade setuptools build
    - name : Build package
      run: python -m build .
    - name : Install package and doc dependencies
      run: | 
        pip install .
        pip install -r requirements.txt
        pip install -r doc/requirements.txt
      # TODO: install a conda env from ./doc/envrionment.yml instead?
    - name: Build documentation
      # building html is necessary to include the module docstrings with autodoc
      run: python -m sphinx -b html ./doc ./doc/sphinx_build
    - name: Run doctests
      run: |
        python -m sphinx -b doctest ./doc ./doc/sphinx_build
